<div class="container">
    <% if @conversation.sender_id == current_user.id %>
      <% chat_partner = User.find(@conversation.recipient_id) %>
    <% else %>
      <% chat_partner = User.find(@conversation.sender_id) %>
    <% end %>


  <div class="chat-header">
    <h2>Chat with <%= chat_partner.username %></h2>
  </div>

  <div class="messages-container">
      <% @sorted_messages.each do |message| %>
      <% message %>
        <%= render "message_partial", message: message, user_is_messages_author: message.user_id == current_user.id %>
    <% end %>
  </div>

    <div>
      <%= simple_form_for [@conversation, @message], remote: true do |f| %>
        <%= f.input :body, placeholder: "Write your message", label: false %>
        <%= button_tag type: 'submit', class: "btn-orange-chat" do %>
          <i class="far fa-paper-plane"></i>
        <% end %>
      <% end %>
    </div>

    <%= link_to "Show activity", activity_path(@conversation.activity_id) %>
    <%= link_to "All messages", conversations_path %>

<br>
<br>
<br>
<br>


  <% content_for :after_js do %>
    <script>
    scrollLastMessageIntoView();
    App["conversation_<%= @conversation.id %>"] = App.cable.subscriptions.create(
      {channel: 'ConversationsChannel', conversation_id: <%= @conversation.id %>},
      {
        received: (data) => {
          if (data.current_user_id !== <%= current_user.id %>) {
            messageContainer = document.querySelector('.messages-container');
            messageContainer.insertAdjacentHTML('beforeend', data.message_par);
            scrollLastMessageIntoView();
          }
        }
      }
    )
    </script>
  <% end %>
</div>

